<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Dostępności Produktów x-kom</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        h1 {
            margin: 0;
            color: #333;
        }

        .status {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        .available {
            color: green;
            font-weight: bold;
        }

        .unavailable {
            color: red;
        }

        .product-link {
            color: #0066cc;
            text-decoration: none;
        }

        .product-link:hover {
            text-decoration: underline;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            padding: 8px 16px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0055aa;
        }

        #lastChecked {
            font-style: italic;
            margin-top: 5px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #0066cc;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        .error {
            color: red;
            font-weight: bold;
            margin: 15px 0;
        }

        .time-since {
            color: #666;
            font-size: 0.9em;
        }

        #urlForm {
            margin-bottom: 20px;
        }

        #urlInput {
            width: 70%;
            padding: 8px;
            margin-right: 10px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Monitor Dostępności Produktów x-kom</h1>
    </div>

    <div class="status">
        <h3>Informacje o monitoringu</h3>
        <p>Narzędzie sprawdza dostępność produktów z wybranej strony x-kom poprzez weryfikację obecności przycisku
            "Dodaj do koszyka" na stronie produktu.</p>
        <p id="lastChecked">Ostatnie sprawdzenie: Nigdy</p>
    </div>

    <div id="urlForm">
        <h3>Wybierz stronę z produktami do monitorowania</h3>
        <input type="text" id="urlInput"
            placeholder="URL strony z produktami (np. https://www.x-kom.pl/lp/technologia-po-prostu)"
            value="https://www.x-kom.pl/lp/technologia-po-prostu">
        <button id="fetchProductsButton">Pobierz produkty</button>
    </div>

    <div class="controls">
        <button id="checkNowButton">Sprawdź dostępność teraz</button>
        <span id="spinner" class="spinner hidden"></span>
    </div>

    <div id="error" class="error hidden"></div>

    <div id="results">
        <h2>Wyniki monitorowania</h2>
        <div id="productsContainer">
            </div>
    </div>

    <script>
        // Główne ustawienia
        const CORS_PROXY = 'https://corsproxy.io/?';
        let products = [];

        // Elementy DOM
        const productsContainer = document.getElementById('productsContainer');
        const lastCheckedEl = document.getElementById('lastChecked');
        const spinner = document.getElementById('spinner');
        const errorEl = document.getElementById('error');
        const fetchProductsButton = document.getElementById('fetchProductsButton');
        const checkNowButton = document.getElementById('checkNowButton');
        const urlInput = document.getElementById('urlInput');

        // Funkcja inicjalizująca
        function init() {
            // Ładowanie zapisanych produktów z localStorage
            loadFromStorage();

            // Ustawienie obsługi zdarzeń dla przycisków
            fetchProductsButton.addEventListener('click', fetchProductsFromUrl);
            checkNowButton.addEventListener('click', checkAvailability);

            // Wyświetlenie ostatnio zapisanych wyników
            updateTable();
        }

        // Funkcja pobierająca produkty ze strony x-kom
        async function fetchProductsFromUrl() {
            showSpinner();
            hideError();

            const url = urlInput.value.trim();
            if (!url || !url.includes('x-kom.pl')) {
                showError('Proszę podać prawidłowy adres URL strony x-kom');
                hideSpinner();
                return;
            }

            try {
                // Pobieranie strony przez CORS proxy
                const response = await fetch(CORS_PROXY + encodeURIComponent(url));
                const html = await response.text();

                // Parsowanie HTML do obiektu DOM
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Wyszukiwanie linków do produktów - używamy różnych selektorów, aby złapać więcej produktów
                const productLinks = Array.from(doc.querySelectorAll('a[href*="/p/"]'));

                // Filtrowanie unikalnych linków produktów
                const uniqueLinks = new Set();
                const newProducts = [];
                let currentSectionName = "Inne Produkty"; // Domyślna nazwa sekcji

                // Przetwarzanie znalezionych linków
                for (const link of productLinks) {
                    const href = link.getAttribute('href');
                    if (href && href.includes('/p/')) {
                        // Wyodrębnij pełny URL produktu i usuń parametry URL
                        let fullUrl = href.startsWith('http') ? href : `https://www.x-kom.pl${href}`;
                        fullUrl = fullUrl.split('?')[0]; // Usuń parametry URL

                        const productId = extractProductId(fullUrl);

                        if (productId && !uniqueLinks.has(productId)) {
                            uniqueLinks.add(productId);

                            // Szukaj nazwy produktu w najbliższym elemencie zawierającym tekst
                            let productName = '';
                            let textElement = link.querySelector('h3') || link.querySelector('.name') || link.querySelector(
                                'div[data-name]');
                            let sectionElement = link.closest('.recommended-products, .product-carousel'); // Najbliższy element karuzeli

                            if (textElement) {
                                if (textElement.hasAttribute('data-name')) {
                                    productName = textElement.getAttribute('data-name');
                                } else {
                                    productName = textElement.textContent.trim();
                                }
                            } else {
                                productName = link.textContent.trim();
                            }

                            if (sectionElement) {
                                // Pobierz nazwę sekcji z elementu karuzeli
                                const sectionTitleElement = sectionElement.querySelector('.section-title h2, .title-wrapper h2, .carousel-header h2'); // Szukaj różnych tytułów
                                if (sectionTitleElement) {
                                    currentSectionName = sectionTitleElement.textContent.trim();
                                } else {
                                    currentSectionName = sectionElement.id || sectionElement.className || "Inne Produkty"; // Fallback
                                }
                            } else {
                                currentSectionName = "Inne Produkty";
                            }

                            if (!productName || productName.length < 5) {
                                // Pobieramy nazwę bezpośrednio z karty produktu
                                productName = await fetchProductNameFromPage(fullUrl);
                                if (productName) {
                                    newProducts.push({
                                        id: productId,
                                        name: productName || `Produkt ${productId}`,
                                        url: fullUrl,
                                        available: null,
                                        lastChecked: null,
                                        section: currentSectionName
                                    });
                                }

                            } else {
                                newProducts.push({
                                    id: productId,
                                    name: productName || `Produkt ${productId}`,
                                    url: fullUrl,
                                    available: null,
                                    lastChecked: null,
                                    section: currentSectionName
                                });
                            }
                        }
                    }
                }

                // Aktualizacja listy produktów
                if (newProducts.length > 0) {
                    products = mergeProducts(products, newProducts);
                    saveToStorage();
                    updateTable();
                    checkAvailability();
                } else {
                    showError('Nie znaleziono produktów na podanej stronie.');
                }
            } catch (error) {
                console.error('Błąd podczas pobierania produktów:', error);
                showError('Wystąpił błąd podczas pobierania listy produktów. Sprawdź konsolę developera.');
            } finally {
                hideSpinner();
            }
        }

        // Funkcja pobierająca nazwę produktu bezpośrednio z karty produktu
        async function fetchProductNameFromPage(url) {
            try {
                const response = await fetch(CORS_PROXY + encodeURIComponent(url));
                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Próbujemy znaleźć tytuł produktu na stronie
                const title = doc.querySelector('h1') ||
                    doc.querySelector('title') ||
                    doc.querySelector('meta[property="og:title"]');

                let productName = null;

                if (title) {
                    if (title.tagName === 'META') {
                        productName = title.getAttribute('content');
                    } else {
                        productName = title.textContent.trim();
                    }
                }
                return productName;

                // Krótka pauza między żądaniami, aby nie przeciążyć serwera
                await new Promise(resolve => setTimeout(resolve, 500));



            } catch (error) {
                console.error(`Błąd podczas pobierania nazwy produktu :`, error);
                return null;
            }
        }

        // Łączenie istniejących produktów z nowymi
        function mergeProducts(existingProducts, newProducts) {
            const productMap = {};

            // Najpierw dodaj istniejące produkty do mapy
            existingProducts.forEach(product => {
                productMap[product.id] = product;
            });

            // Dodaj lub zaktualizuj nowymi produktami
            newProducts.forEach(product => {
                if (productMap[product.id]) {
                    // Aktualizuj tylko nazwę, zachowaj historię i status
                    productMap[product.id].name = product.name;
                    productMap[product.id].url = product.url;
                    productMap[product.id].section = product.section; // Zachowaj sekcję
                } else {
                    // Dodaj nowy produkt
                    productMap[product.id] = product;
                }
            });

            // Konwertuj mapę z powrotem do tablicy
            return Object.values(productMap);
        }

        // Funkcja wyodrębniająca ID produktu z URL
        function extractProductId(url) {
            const match = url.match(/\/p\/(\d+)-/);
            return match ? match[1] : null;
        }

        // Funkcja sprawdzająca dostępność produktów
        async function checkAvailability() {
            if (products.length === 0) {
                showError('Brak produktów do sprawdzenia. Najpierw pobierz listę produktów.');
                return;
            }

            showSpinner();
            hideError();

            const now = new Date();
            const timestamp = now.toLocaleString();

            lastCheckedEl.textContent = `Ostatnie sprawdzenie: ${timestamp}`;

            try {
                // Sprawdzanie każdego produktu
                for (const product of products) {
                    try {
                        const response = await fetch(CORS_PROXY + encodeURIComponent(product.url));
                        const html = await response.text();

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');

                        // Sprawdzenie nazwy produktu, jeśli nie mamy jej jeszcze lub jest domyślna
                        if (!product.name || product.name === `Produkt ${product.id}`) {
                            const title = doc.querySelector('h1') || doc.querySelector('title');
                            if (title) {
                                product.name = title.textContent.trim();
                            }
                        }

                        // Sprawdzenie czy produkt jest dostępny
                        let isAvailable = false;
                        const addToCartButton = doc.querySelector('button[title="Dodaj do koszyka"]') ||
                            doc.querySelector('button[data-testid="add-to-cart-button"]') ||
                            doc.querySelector('button[data-cy="add-to-cart-button"]') ||
                            doc.querySelector('div[data-testing-id="add-to-cart-container"] button');

                        const unavailableTextElement = doc.querySelector('.unavailable-product') ||
                            doc.querySelector('div[data-testid="unavailable-product"]') ||
                            doc.querySelector('.unavailable-label');

                        const notifyMeButton = doc.querySelector('button[data-disabled="false"][width="content"]');

                        if (addToCartButton) {
                            isAvailable = true;
                        } else if (unavailableTextElement || notifyMeButton) {
                            isAvailable = false;
                        } else {
                            const allButtons = doc.querySelectorAll('button');
                            for (const button of allButtons) {
                                if (button.textContent.includes('Dodaj do koszyka')) {
                                    isAvailable = true;
                                    break;
                                }
                            }
                        }

                        // Aktualizacja statusu dostępności
                        product.available = isAvailable;
                        product.lastChecked = timestamp;

                        // Krótka pauza między żądaniami, aby nie przeciążyć serwera
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (error) {
                        console.error(`Błąd sprawdzania produktu ${product.id}:`, error);
                        // Nie zmieniamy statusu produktu w przypadku błędu
                    }
                }

                // Zapisanie zaktualizowanych danych
                saveToStorage();

                // Aktualizacja tabeli
                updateTable();
            } catch (error) {
                console.error('Błąd podczas sprawdzania dostępności:', error);
                showError('Wystąpił błąd podczas sprawdzania dostępności produktów.');
            } finally {
                hideSpinner();
            }
        }

        // Funkcja aktualizująca tabelę z produktami
        function updateTable() {
            productsContainer.innerHTML = ''; // Czyścimy kontener

            if (products.length === 0) {
                const row = document.createElement('p');
                row.textContent = 'Brak produktów do wyświetlenia. Użyj przycisku "Pobierz produkty".';
                productsContainer.appendChild(row);
                return;
            }

            // Grupowanie produktów po sekcjach
            const groupedProducts = {};
            products.forEach(product => {
                if (!groupedProducts[product.section]) {
                    groupedProducts[product.section] = [];
                }
                groupedProducts[product.section].push(product);
            });

            // Iteracja po sekcjach i tworzenie tabel
            for (const sectionName in groupedProducts) {
                if (groupedProducts.hasOwnProperty(sectionName)) {
                    const sectionProducts = groupedProducts[sectionName];

                    const sectionTitle = document.createElement('h2');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = sectionName;
                    productsContainer.appendChild(sectionTitle);

                    const table = document.createElement('table');
                    table.className = 'products-table';

                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                        <tr>
                            <th>Nazwa produktu</th>
                            <th>Link</th>
                            <th>Dostępność</th>
                        </tr>
                    `;
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');

                    sectionProducts.forEach(product => {
                        const row = document.createElement('tr');
                        const availabilityText = product.available === null ? 'Nieznana' : product.available ? 'Dostępny' : 'Niedostępny';
                        const availabilityClass = product.available === null ? '' : product.available ? 'available' : 'unavailable';

                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td><a href="${product.url}" class="product-link" target="_blank" rel="noopener noreferrer">Link</a></td>
                            <td class="${availabilityClass}">${availabilityText}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    productsContainer.appendChild(table);
                }
            }
        }

        // Funkcje pomocnicze
        function showSpinner() {
            spinner.classList.remove('hidden');
        }

        function hideSpinner() {
            spinner.classList.add('hidden');
        }

        function showError(message) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideError() {
            errorEl.classList.add('hidden');
        }

        // Funkcje localStorage
        function saveToStorage() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function loadFromStorage() {
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
        }

        // Inicjalizacja skryptu
        init();
    </script>
</body>

</html>
